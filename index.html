<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ç©¶æ¥µãƒ‘ãƒãƒ³ã‚³ ãƒ•ãƒ«çµ±åˆç‰ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
body{
  margin:0;background:#020617;color:#fff;
  font-family:sans-serif;text-align:center;overflow:hidden
}
h1{
  margin:8px;font-size:22px;
  transition:.3s;
}
.kaku h1{ color:#facc15; text-shadow:0 0 10px #fde047 }
#ui{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-bottom:6px}
button{
  padding:10px 14px;font-size:15px;border:none;
  border-radius:10px;cursor:pointer
}
#fire{background:#22c55e}
#fs{background:#38bdf8}
#reset{background:#ef4444}
#auto{background:#a855f7}
canvas{background:#020617;display:block;margin:0 auto;border-radius:14px}
#panel{margin-top:4px;font-size:14px}
#effect{position:fixed;inset:0;pointer-events:none}
</style>
</head>

<body>
<h1>ğŸ° ç©¶æ¥µãƒ‘ãƒãƒ³ã‚³ï¼ˆå®Œå…¨ç‰ˆï¼‰</h1>

<div id="ui">
  <button id="fire">ç™ºå°„</button>
  <button id="auto">AUTO OFF</button>
  <button id="fs">FULL</button>
  <button id="reset">RESET</button>
</div>
<div id="ui">
  <button id="save">SAVE</button>
  <button id="load">LOAD</button>
  <button id="sound">SOUND ON</button>
</div>

<canvas id="c" width="360" height="640"></canvas>
<div id="panel">
ç‰:<span id="balls">0</span>ï½œ
å¾—ç‚¹:<span id="score">0</span>ï½œ
ç¢ºå¤‰:<span id="kaku">OFF</span>
</div>
<canvas id="effect"></canvas>

<script>
/* ===== DOM ===== */
const fireBtn=fire, autoBtn=auto, fsBtn=fs, resetBtn=reset;
const saveBtn=save, loadBtn=load, soundBtn=sound;
const ballsSpan=balls, scoreSpan=score, kakuSpan=kaku;
const c=document.getElementById('c'), ctx=c.getContext('2d');
const efx=document.getElementById('effect'), ectx=efx.getContext('2d');

/* ===== çŠ¶æ…‹ ===== */
let W=c.width,H=c.height;
let balls=[], pins=[];
let score=0, ballCount=50;
let auto=false, kakuhen=false, soundOn=true;

/* ===== éŸ³ ===== */
const seFire=new Audio();
const seHit=new Audio();

/* ===== ãƒªã‚µã‚¤ã‚º ===== */
function resize(){
  const s=Math.min(innerWidth/W,(innerHeight-150)/H);
  c.style.transform=`scale(${s})`;
  efx.width=innerWidth; efx.height=innerHeight;
}
addEventListener('resize',resize); resize();

/* ===== ãƒœãƒ¼ãƒ« ===== */
class Ball{
  constructor(){
    this.x=W/2+(Math.random()*40-20);
    this.y=20; this.vx=Math.random()*2-1; this.vy=2;
    this.r=5; this.alive=true;
  }
  update(){
    this.vy+=0.06;
    this.x+=this.vx; this.y+=this.vy;
    if(this.x<this.r||this.x>W-this.r) this.vx*=-1;

    for(const p of pins){
      const d=Math.hypot(this.x-p.x,this.y-p.y);
      if(d<this.r+p.r){
        const a=Math.atan2(this.y-p.y,this.x-p.x);
        this.vx=Math.cos(a)*2.5;
        this.vy=Math.sin(a)*2.5;
      }
    }
    if(this.y>H-40){
      if(this.x>W*0.4&&this.x<W*0.6) hit();
      this.alive=false;
    }
  }
  draw(){
    ctx.fillStyle='#e5e7eb';
    ctx.beginPath();ctx.arc(this.x,this.y,this.r,0,Math.PI*2);ctx.fill();
  }
}

/* ===== é‡˜ ===== */
for(let y=120;y<480;y+=50)
for(let x=50;x<W-40;x+=50)
pins.push({x:x+(y%100?25:0),y,r:6});

/* ===== å½“ãŸã‚Š ===== */
function hit(){
  score+=kakuhen?500:100;
  confetti();
  if(Math.random()<0.25){
    kakuhen=true;
    document.body.classList.add('kaku');
    setTimeout(()=>{
      kakuhen=false;
      document.body.classList.remove('kaku');
    },8000);
  }
}

/* ===== æç”» ===== */
function draw(){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#38bdf8';
  pins.forEach(p=>{
    ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();
  });
  ctx.fillStyle=kakuhen?'#facc15':'#22c55e';
  ctx.fillRect(W*0.4,H-30,W*0.2,20);

  balls.forEach(b=>b.update());
  balls=balls.filter(b=>b.alive);
  balls.forEach(b=>b.draw());

  ballsSpan.textContent=ballCount;
  scoreSpan.textContent=score;
  kakuSpan.textContent=kakuhen?'ON':'OFF';

  requestAnimationFrame(draw);
}
draw();

/* ===== æ“ä½œ ===== */
function fire(){
  if(ballCount<=0)return;
  balls.push(new Ball()); ballCount--;
}
fireBtn.onclick=fire;
c.addEventListener('touchstart',fire);

autoBtn.onclick=()=>{
  auto=!auto;
  autoBtn.textContent=auto?'AUTO ON':'AUTO OFF';
};

setInterval(()=>auto&&fire(),300);

fsBtn.onclick=()=>{
  if(!document.fullscreenElement) document.body.requestFullscreen();
  else document.exitFullscreen();
};

resetBtn.onclick=()=>{
  balls=[]; score=0; ballCount=50;
  kakuhen=false; auto=false;
  autoBtn.textContent='AUTO OFF';
  document.body.classList.remove('kaku');
};

/* ===== SAVE / LOAD ===== */
saveBtn.onclick=()=>{
  localStorage.setItem('pachiSave',JSON.stringify({
    score,ballCount,kakuhen,auto
  }));
  alert('ã‚»ãƒ¼ãƒ–å®Œäº†');
};
loadBtn.onclick=()=>{
  const d=localStorage.getItem('pachiSave');
  if(!d)return alert('ãƒ‡ãƒ¼ã‚¿ãªã—');
  const s=JSON.parse(d);
  score=s.score; ballCount=s.ballCount;
  kakuhen=s.kakuhen; auto=s.auto;
  autoBtn.textContent=auto?'AUTO ON':'AUTO OFF';
};

/* ===== æ¼”å‡º ===== */
function confetti(){
  ectx.clearRect(0,0,efx.width,efx.height);
  for(let i=0;i<80;i++){
    ectx.fillStyle=`hsl(${Math.random()*360},80%,60%)`;
    ectx.fillRect(Math.random()*efx.width,Math.random()*efx.height,4,4);
  }
  setTimeout(()=>ectx.clearRect(0,0,efx.width,efx.height),300);
}
</script>
</body>
</html>
