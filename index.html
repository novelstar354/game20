<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ç©¶æ¥µãƒ‘ãƒãƒ³ã‚³ ãƒ•ãƒ«çµ±åˆç‰ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
body{margin:0;background:#020617;color:#fff;font-family:sans-serif;text-align:center;overflow:hidden}
h1{margin:8px;font-size:22px}
#ui{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-bottom:6px}
button{padding:10px 14px;font-size:15px;border:none;border-radius:10px;cursor:pointer}
#fire{background:#22c55e}
#fs{background:#38bdf8}
#reset{background:#ef4444}
#auto{background:#a855f7}
canvas{background:#020617;display:block;margin:0 auto;border-radius:14px}
#panel{margin-top:4px;font-size:14px}
#effect{position:fixed;inset:0;pointer-events:none}
</style>
</head>
<body>
<h1>ğŸ° ç©¶æ¥µãƒ‘ãƒãƒ³ã‚³ï¼ˆå®Œå…¨ç‰ˆï¼‰</h1>

<div id="ui">
  <button id="fire">ç™ºå°„</button>
  <button id="auto">AUTO</button>
  <button id="fs">FULL</button>
  <button id="reset">RESET</button>
</div>
<div id="ui">
  <button id="save">SAVE</button>
  <button id="load">LOAD</button>
  <button id="sound">SOUND ON</button>
</div>

<canvas id="c" width="360" height="640"></canvas>
<div id="panel">ç‰:<span id="balls">0</span>ï½œå¾—ç‚¹:<span id="score">0</span>ï½œç¢ºå¤‰:<span id="kaku">OFF</span></div>
<canvas id="effect"></canvas>

<script>
// ===== DOMå–å¾—ï¼ˆå…ˆã«å¿…ãšå®šç¾©ï¼‰ =====
const fireBtn = document.getElementById('fire');
const autoBtn = document.getElementById('auto');
const fsBtn = document.getElementById('fs');
const resetBtn = document.getElementById('reset');
const saveBtn = document.getElementById('save');
const loadBtn = document.getElementById('load');
const soundBtn = document.getElementById('sound');

const ballsSpan = document.getElementById('balls');
const scoreSpan = document.getElementById('score');
const kakuSpan  = document.getElementById('kaku');

const c = document.getElementById('c');
const ctx = c.getContext('2d');
const efx = document.getElementById('effect');
const ectx = efx.getContext('2d');

// ===== ã‚²ãƒ¼ãƒ çŠ¶æ…‹ =====
let W = c.width, H = c.height;
let balls = [], pins = [];
let score = 0;
let ballCount = 50;
let auto = false;
let kakuhen = false;
let soundOn = true;

// ===== ã‚µã‚¦ãƒ³ãƒ‰ =====
const seFire = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=');
const seHit  = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=');

// ===== ãƒªã‚µã‚¤ã‚º =====
function resize(){
  const s = Math.min(innerWidth / W, (innerHeight - 150) / H);
  c.style.transform = `scale(${s})`;
  efx.width = innerWidth;
  efx.height = innerHeight;
}
window.addEventListener('resize', resize);
resize();

// ===== ãƒœãƒ¼ãƒ« =====
class Ball{
  constructor(){
    this.x = W/2 + (Math.random()*40 - 20);
    this.y = 20;
    this.vx = Math.random()*2 - 1;
    this.vy = 2;
    this.r = 5;
    this.alive = true;
  }
  update(){
    this.vy += 0.06;
    this.x += this.vx;
    this.y += this.vy;

    if(this.x < this.r || this.x > W - this.r) this.vx *= -1;

    for(const p of pins){
      const dx = this.x - p.x;
      const dy = this.y - p.y;
      const d = Math.hypot(dx, dy);
      if(d < this.r + p.r){
        const a = Math.atan2(dy, dx);
        this.vx = Math.cos(a) * 2.5;
        this.vy = Math.sin(a) * 2.5;
      }
    }

    if(this.y > H - 40){
      if(this.x > W*0.4 && this.x < W*0.6) hit();
      this.alive = false;
    }
  }
  draw(){
    ctx.fillStyle = '#e5e7eb';
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.r, 0, Math.PI*2);
    ctx.fill();
  }
}

// ===== é‡˜ =====
function createPins(){
  pins = [];
  for(let y=120; y<480; y+=50){
    for(let x=50; x<W-40; x+=50){
      pins.push({ x: x + (y%100 ? 25 : 0), y, r: 6 });
    }
  }
}
createPins();

// ===== å½“ãŸã‚Š =====
function hit(){
  if(soundOn){ seHit.currentTime = 0; seHit.play(); }
  score += kakuhen ? 500 : 100;
  confetti();
  if(Math.random() < 0.25){
    kakuhen = true;
    setTimeout(()=>kakuhen=false, 8000);
  }
}

// ===== æç”» =====
function drawPins(){
  ctx.fillStyle = '#38bdf8';
  for(const p of pins){
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
    ctx.fill();
  }
}

function drawGoal(){
  ctx.fillStyle = kakuhen ? '#facc15' : '#22c55e';
  ctx.fillRect(W*0.4, H-30, W*0.2, 20);
  ctx.fillStyle = '#000';
  ctx.fillText('GOAL', W*0.47, H-15);
}

function update(){
  ctx.clearRect(0,0,W,H);
  drawPins();
  drawGoal();

  balls.forEach(b=>b.update());
  balls = balls.filter(b=>b.alive);
  balls.forEach(b=>b.draw());

  ballsSpan.textContent = ballCount;
  scoreSpan.textContent = score;
  kakuSpan.textContent  = kakuhen ? 'ON' : 'OFF';

  requestAnimationFrame(update);
}
update();

// ===== æ“ä½œ =====
function fire(){
  if(ballCount <= 0) return;
  if(soundOn){ seFire.currentTime = 0; seFire.play(); }
  balls.push(new Ball());
  ballCount--;
}

fireBtn.onclick = fire;
autoBtn.onclick = ()=> auto = !auto;
resetBtn.onclick = ()=>{ balls=[]; score=0; ballCount=50; kakuhen=false; };
fsBtn.onclick = ()=>{
  if(!document.fullscreenElement) c.requestFullscreen();
  else document.exitFullscreen();
};

setInterval(()=>{ if(auto) fire(); }, 300);
window.addEventListener('keydown', e=>{
  if(e.code==='Space') fire();
  if(e.key==='f') fsBtn.click();
});

// ===== ã‚»ãƒ¼ãƒ– / ãƒ­ãƒ¼ãƒ‰ =====
saveBtn.onclick = ()=>{
  const data = { score, ballCount, kakuhen };
  localStorage.setItem('pachinkoSave', JSON.stringify(data));
  alert('ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸ');
};

loadBtn.onclick = ()=>{
  const d = localStorage.getItem('pachinkoSave');
  if(!d){ alert('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãªã—'); return; }
  const data = JSON.parse(d);
  score = data.score;
  ballCount = data.ballCount;
  kakuhen = data.kakuhen;
};

soundBtn.onclick = ()=>{
  soundOn = !soundOn;
  soundBtn.textContent = soundOn ? 'SOUND ON' : 'SOUND OFF';
};

// ===== æ¼”å‡º =====
function confetti(){
  for(let i=0;i<80;i++){
    const x = Math.random()*efx.width;
    const y = Math.random()*efx.height;
    ectx.fillStyle = `hsl(${Math.random()*360},80%,60%)`;
    ectx.fillRect(x,y,4,4);
  }
  setTimeout(()=>ectx.clearRect(0,0,efx.width,efx.height),300);
}
</script>
</body>
</html>
