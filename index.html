<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>PACHINKO ULTIMATE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
html,body{margin:0;background:#020617;color:#fff;font-family:sans-serif;overflow:hidden}
#ui{position:fixed;top:8px;left:8px;z-index:10;font-size:13px}
button{padding:6px 10px;border:none;border-radius:8px;margin:2px;background:#22c55e;color:#000}
canvas{display:block}
#msg{
 position:fixed;inset:0;display:flex;
 align-items:center;justify-content:center;
 font-size:48px;font-weight:bold;
 pointer-events:none;opacity:0;
}
.flash{position:fixed;inset:0;background:white;opacity:0;pointer-events:none}
</style>
</head>
<body>

<div id="ui">
 出玉:<span id="balls">0</span><br>
 最高:<span id="best">0</span><br>
 モード:<span id="mode">NORMAL</span><br>
 <button id="shoot">発射</button>
 <button id="auto">AUTO</button>
 <button id="sound">SOUND</button>
 <button id="fs">FULL</button>
 <button id="reset">RESET</button>
</div>

<div id="msg"></div>
<div class="flash" id="flash"></div>
<canvas id="c"></canvas>

<script>
const c=document.getElementById("c"),ctx=c.getContext("2d");
function resize(){c.width=innerWidth;c.height=innerHeight}
resize();addEventListener("resize",resize);

/* 状態 */
let balls=[],pins=[];
let out=0,best=+localStorage.best||0,shots=0;
let rush=false,auto=false,sound=true;

/* UI */
bestSpan.textContent=best;

/* 効果音 */
const ac=new AudioContext();
function se(f,t=0.1){
 if(!sound)return;
 const o=ac.createOscillator(),g=ac.createGain();
 o.frequency.value=f;o.connect(g);g.connect(ac.destination);
 g.gain.value=0.12;o.start();o.stop(ac.currentTime+t);
}

/* ピン */
for(let y=140;y<innerHeight-220;y+=60){
 for(let x=30;x<innerWidth;x+=60){
  pins.push({x,y,r:5});
 }
}

/* 発射 */
function shoot(){
 balls.push({x:c.width/2,y:40,vx:(Math.random()-0.5)*2,vy:2,r:6,alive:true});
 shots++; se(500);
}
shootBtn.onclick=shoot;
c.addEventListener("touchstart",shoot);

/* ボタン */
autoBtn.onclick=()=>auto=!auto;
soundBtn.onclick=()=>sound=!sound;
fsBtn.onclick=()=>document.body.requestFullscreen();
resetBtn.onclick=()=>{
 localStorage.clear();
 out=best=shots=0;
 ballsSpan.textContent=0;bestSpan.textContent=0;
}

/* キーボード */
addEventListener("keydown",e=>{
 if(e.key===" ")shoot();
 if(e.key==="a")auto=!auto;
 if(e.key==="f")document.body.requestFullscreen();
});

/* 演出 */
function show(text,color){
 msg.textContent=text;
 msg.style.color=color;
 msg.style.opacity=1;
 setTimeout(()=>msg.style.opacity=0,1000);
}
function flash(){
 flashDiv.style.opacity=1;
 setTimeout(()=>flashDiv.style.opacity=0,120);
}

/* ループ */
function loop(){
 ctx.clearRect(0,0,c.width,c.height);

 // ピン
 ctx.fillStyle="#64748b";
 pins.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill()});

 // 入賞ゾーン
 const gy=c.height-80;
 ctx.fillStyle=rush?"#fb7185":"#facc15";
 ctx.fillRect(0,gy,c.width,50);

 balls.forEach(b=>{
  if(!b.alive)return;
  b.vy+=0.08;b.x+=b.vx;b.y+=b.vy;
  if(b.x<b.r||b.x>c.width-b.r)b.vx*=-1;

  pins.forEach(p=>{
   const d=Math.hypot(b.x-p.x,b.y-p.y);
   if(d<b.r+p.r){b.vx+=(b.x-p.x)*0.02;b.vy=-Math.abs(b.vy)}
  });

  if(b.y>gy){
   let add=rush?15:5;
   if(Math.random()<0.08){
    add=100;rush=true;
    show("BIG BONUS!","gold");flash();se(1200,0.3);
   }
   out+=add;
   if(out>best){best=out;localStorage.best=best}
   ballsSpan.textContent=out;
   bestSpan.textContent=best;
   modeSpan.textContent=rush?"RUSH":"NORMAL";
   b.alive=false;se(800);
  }

  ctx.fillStyle="#38bdf8";
  ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);ctx.fill();
 });

 if(auto && Math.random()<0.04)shoot();
 requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
